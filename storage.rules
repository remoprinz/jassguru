rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    // --- Profilbilder ---
    match /profilePictures/{userId}/{allPaths=**} {
       // Jeder darf lesen (Bilder anzeigen)
       allow read: if true; 
       
       // Nur der eigene User darf sein Profilbild hochladen/löschen
       // ✅ VERBESSERTE SICHERHEIT: Strikte Validierung mit HEIC/HEIF Support
       allow write, delete: if request.auth != null 
                            && request.auth.uid == userId
                            && request.resource.size < 5 * 1024 * 1024  // Max 5MB
                            && request.resource.contentType.matches('image/(jpeg|jpg|png|webp|gif|heic|heif)'); // Inkl. HEIC/HEIF für iOS
    }

    // --- Gruppenlogos ---
    // Pfad: groupLogos/{userId}/{groupId}/{fileName}
    // ✅ PERFORMANCE-OPTIMIERT: Keine Firestore-Lookups mehr
    // Admin-Prüfung erfolgt im Frontend/Backend
    match /groupLogos/{userId}/{groupId}/{allPaths=**} { 
       // Jeder darf lesen (Logos anzeigen)
       allow read: if true; 
       
       // ✅ PERFORMANCE: Nur Basic-Validierung ohne Firestore-Lookups
       allow write: if request.auth != null 
                       && request.auth.uid == userId
                       && request.resource.size < 5 * 1024 * 1024  // Max 5MB für Logos
                       && request.resource.contentType.matches('image/(jpeg|jpg|png|webp|gif|heic|heif|avif)'); // Inkl. HEIC/HEIF für iOS
       
       // Löschen erlaubt für eigene Uploads
       allow delete: if request.auth != null 
                        && request.auth.uid == userId;
    }

    // ✅ NEU: Turnierlogos - PERFORMANCE-OPTIMIERT
    match /tournamentLogos/{userId}/{tournamentId}/{allPaths=**} {
       allow read: if true;
       
       // ✅ PERFORMANCE: Nur Basic-Validierung ohne Firestore-Lookups
       allow write: if request.auth != null
                       && request.auth.uid == userId
                       && request.resource.size < 5 * 1024 * 1024  // Max 5MB für Turnierlogos
                       && request.resource.contentType.matches('image/(jpeg|jpg|png|webp|gif|heic|heif|avif)'); // Inkl. HEIC/HEIF für iOS
                       
       // Löschen erlaubt für eigene Uploads
       allow delete: if request.auth != null
                        && request.auth.uid == userId;
    }

    // ✅ SICHERHEIT: Alle anderen Pfade explizit blockieren
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
} 